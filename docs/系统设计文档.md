# 智能配餐推荐系统 - 系统设计文档

## 1. 项目概述

### 1.1 项目背景
随着人们健康意识的提高，科学饮食管理成为重要需求。智能配餐推荐系统旨在通过算法和数据分析，为用户提供个性化的饮食推荐方案。

### 1.2 项目目标
- 实现基于用户特征的个性化配餐推荐
- 提供营养计算和可视化功能
- 支持用户饮食历史管理
- 提供友好的用户交互界面

### 1.3 技术栈
- **编程语言**：C++17
- **构建工具**：CMake 3.10+
- **开发环境**：Visual Studio 2022
- **数据存储**：文本文件（TXT格式）
- **编译器**：MSVC (Windows) / GCC (Linux)

## 2. 系统架构

### 2.1 架构设计

系统采用分层架构设计：

```
┌─────────────────────────────────────────────┐
│          表示层 (Presentation Layer)         │
│        控制台界面 / 用户交互             │
└─────────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────────┐
│         业务逻辑层 (Business Layer)          │
│   推荐引擎 / 营养计算 / 用户管理         │
└─────────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────────┐
│        数据访问层 (Data Access Layer)        │
│       数据库管理 / 文件I/O              │
└─────────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────────┐
│         数据层 (Data Layer)                  │
│    users.txt / foods.txt / meals.txt       │
└─────────────────────────────────────────────┘
```

### 2.2 核心模块

#### 2.2.1 用户管理模块
- 用户注册与登录
- 个人信息管理
- 营养目标计算
- 口味偏好管理

#### 2.2.2 食物数据库模块
- 食物信息管理
- 营养成分数据
- 口味标签系统
- 食物分类管理

#### 2.2.3 推荐引擎模块
- 推荐算法实现
- 食物评分计算
- 餐单生成
- 历史数据分析

#### 2.2.4 营养计算模块
- BMR计算
- 每日营养目标计算
- 营养素统计
- 营养可视化

#### 2.2.5 数据管理模块
- 数据持久化
- 文件读写
- 数据验证
- 数据迁移

## 3. 详细设计

### 3.1 类设计

#### 3.1.1 User类

```cpp
class User {
private:
    int id;                          // 用户ID
    string username;                 // 用户名
    string password;                 // 密码
    int age;                         // 年龄
    double weight;                   // 体重(kg)
    double height;                   // 身高(cm)
    string gender;                   // 性别
    string activityLevel;            // 活动水平
    double dailyCalorieGoal;         // 每日卡路里目标
    double dailyProteinGoal;         // 每日蛋白质目标
    double dailyCarbGoal;            // 每日碳水目标
    double dailyFatGoal;             // 每日脂肪目标
    set<string> preferredTags;       // 喜欢的口味标签
    set<string> avoidedTags;         // 避免的口味标签
    set<string> allergens;           // 过敏源

public:
    // 构造函数
    User();
    User(int id, const string& username, const string& password);
    
    // Getters & Setters
    // ...
    
    // 业务方法
    void calculateNutritionGoals();  // 计算营养目标
    void displayProfile() const;     // 显示个人资料
    string toString() const;         // 序列化
};
```

**职责**：
- 管理用户基本信息
- 计算营养目标
- 管理口味偏好

**关键方法**：
- `calculateNutritionGoals()`: 使用Mifflin-St Jeor公式计算BMR和营养目标

#### 3.1.2 Food类

```cpp
class Food {
private:
    int id;                          // 食物ID
    string name;                     // 食物名称
    double calories;                 // 卡路里(kcal)
    double protein;                  // 蛋白质(g)
    double carbohydrates;            // 碳水化合物(g)
    double fat;                      // 脂肪(g)
    double fiber;                    // 纤维素(g)
    set<string> tags;                // 口味标签
    string category;                 // 食物类别

public:
    // 构造函数
    Food();
    Food(int id, const string& name, double cal, double prot, 
         double carb, double fat, double fiber,
         const set<string>& tags, const string& category);
    
    // Getters & Setters
    // ...
    
    // 业务方法
    void addTag(const string& tag);
    bool hasTag(const string& tag) const;
    void displayInfo() const;
    string toString() const;
};
```

**职责**：
- 存储食物营养信息
- 管理口味标签
- 提供食物分类

#### 3.1.3 Meal类

```cpp
class Meal {
private:
    int id;                          // 餐次ID
    int userId;                      // 用户ID
    string date;                     // 日期
    string mealType;                 // 餐次类型
    vector<Food> foods;              // 食物列表
    double totalCalories;            // 总热量
    double totalProtein;             // 总蛋白质
    double totalCarbs;               // 总碳水
    double totalFat;                 // 总脂肪
    bool isRecommended;              // 是否推荐

public:
    // 构造函数
    Meal();
    Meal(int id, int userId, const string& date, const string& mealType);
    
    // 业务方法
    void addFood(const Food& food);
    void removeFood(int foodId);
    void calculateTotals();
    void displayMeal() const;
    string toString() const;
};
```

**职责**：
- 管理单次餐食
- 计算营养总计
- 支持食物增删

#### 3.1.4 Database类

```cpp
class Database {
private:
    vector<User> users;
    vector<Food> foods;
    map<int, vector<Meal>> mealHistory;
    string usersFile;
    string foodsFile;
    string mealsFile;

public:
    // 构造函数
    Database();
    Database(const string& usersFile, const string& foodsFile, 
             const string& mealsFile);
    
    // 数据加载
    bool loadUsers();
    bool loadFoods();
    bool loadMeals();
    
    // 数据保存
    bool saveUsers();
    bool saveFoods();
    bool saveMeals();
    
    // 用户操作
    bool addUser(const User& user);
    bool updateUser(const User& user);
    User* findUserByUsername(const string& username);
    User* findUserById(int id);
    
    // 食物操作
    bool addFood(const Food& food);
    vector<Food> getAllFoods() const;
    vector<Food> searchFoodsByName(const string& keyword) const;
    
    // 餐单操作
    bool addMeal(const Meal& meal);
    vector<Meal> getUserMeals(int userId) const;
    vector<Meal> getUserMealsByDate(int userId, const string& date) const;
    
    // 工具方法
    void initializeSampleData();
};
```

**职责**：
- 数据持久化管理
- CRUD操作实现
- 数据查询和搜索

#### 3.1.5 RecommendationEngine类

```cpp
class RecommendationEngine {
private:
    vector<Food> foodDatabase;
    map<int, vector<Meal>> userHistory;
    
    // 私有辅助方法
    double calculateFoodScore(const Food& food, const User& user,
                             const string& mealType, ...);
    vector<Food> filterFoodsByCategory(const string& category) const;
    bool isAllergenFree(const Food& food, const User& user) const;

public:
    // 构造函数
    RecommendationEngine();
    
    // 数据设置
    void setFoodDatabase(const vector<Food>& foods);
    void loadHistory(const map<int, vector<Meal>>& history);
    
    // 推荐功能
    vector<Meal> recommendDailyMeals(const User& user, const string& date);
    Meal recommendMeal(const User& user, const string& mealType,
                      double targetCalories, ...);
    vector<Food> getAlternativeFoods(const Food& food, const User& user, int count);
    
    // 统计功能
    void displayRecommendationStats(const User& user) const;
};
```

**职责**：
- 实现推荐算法
- 食物评分计算
- 历史数据分析

### 3.2 推荐算法设计

#### 3.2.1 算法流程

```
输入：用户信息，餐次类型，营养目标
    ↓
1. 根据餐次类型确定食物类别
    ↓
2. 从每个类别中筛选候选食物
    ↓
3. 对每个候选食物计算评分
    ↓
4. 评分因素：
   - 营养匹配度（权重：60%）
   - 口味偏好（权重：30%）
   - 餐次适配性（权重：10%）
    ↓
5. 排序并选择最高分食物
    ↓
6. 组合成完整餐单
    ↓
输出：推荐餐单
```

#### 3.2.2 评分公式

```
总分 = 基础分 + 口味分 + 营养分 + 适配分

基础分 = 100

口味分 = 
  喜欢标签数 × 30 - 避免标签数 × 50

营养分 = 
  - |实际热量 - 目标热量| × 0.1
  - |实际蛋白质 - 目标蛋白质| × 0.5
  - |实际碳水 - 目标碳水| × 0.3
  - |实际脂肪 - 目标脂肪| × 0.4

适配分 =
  餐次类别匹配 ? +20 : 0
```

### 3.3 数据库设计

#### 3.3.1 数据文件格式

**users.txt**
```
格式：ID|用户名|密码|年龄|体重|身高|性别|活动水平|热量目标|蛋白质目标|碳水目标|脂肪目标|喜欢标签|避免标签|过敏源

示例：
1|zhangsan|123456|25|65|170|male|moderate|2200|78|275|61|清淡,鲜|辣|海鲜
```

**foods.txt**
```
格式：ID|名称|热量|蛋白质|碳水化合物|脂肪|纤维|标签|类别

示例：
1|白米饭|116|2.6|25.6|0.3|0.3|清淡|主食
5|鸡胸肉|133|24.6|2.5|5.0|0.0|清淡|肉类
```

**meals.txt**
```
格式：ID|用户ID|日期|餐次类型|总热量|总蛋白质|总碳水|总脂肪|是否推荐|食物ID列表

示例：
1|1|2024-01-15|breakfast|450|20|60|12|1|1,15,22
```

#### 3.3.2 数据关系

```
User (1) ─────< (N) Meal
                      │
                      │ (M)
                      │
                      └─────> (N) Food
```

### 3.4 营养计算公式

#### 3.4.1 BMR计算（Mifflin-St Jeor公式）

**男性**：
```
BMR = 10 × weight(kg) + 6.25 × height(cm) - 5 × age + 5
```

**女性**：
```
BMR = 10 × weight(kg) + 6.25 × height(cm) - 5 × age - 161
```

#### 3.4.2 TDEE计算

```
TDEE = BMR × 活动系数

活动系数：
- 久坐：1.2
- 轻度活动：1.375
- 中度活动：1.55
- 重度活动：1.725
- 非常活跃：1.9
```

#### 3.4.3 宏量营养素分配

```
蛋白质目标 = 体重(kg) × 1.2g

碳水化合物目标 = (TDEE × 50%) / 4 kcal/g

脂肪目标 = (TDEE × 25%) / 9 kcal/g
```

## 4. 接口设计

### 4.1 用户接口

#### 4.1.1 主菜单

```
╔══════════════════════════════════════════════════╗
║          智能配餐推荐系统 - 主菜单                 ║
╠══════════════════════════════════════════════════╣
║  1. 获取每日配餐推荐                              ║
║  2. 查看历史记录                                  ║
║  3. 手动调整餐单                                  ║
║  4. 食物数据库查询                                ║
║  5. 营养成分可视化                                ║
║  6. 个人资料管理                                  ║
║  7. 口味偏好设置                                  ║
║  0. 退出登录                                      ║
╚══════════════════════════════════════════════════╝
```

#### 4.1.2 输入验证

- 数字输入：验证范围和类型
- 字符串输入：去除前后空格
- 日期输入：验证格式YYYY-MM-DD
- 选择输入：验证是否在有效范围内

### 4.2 数据接口

#### 4.2.1 文件I/O接口

```cpp
// 读取用户数据
bool loadUsers() -> vector<User>

// 保存用户数据
bool saveUsers(const vector<User>&) -> bool

// 读取食物数据
bool loadFoods() -> vector<Food>

// 保存食物数据
bool saveFoods(const vector<Food>&) -> bool

// 读取餐单数据
bool loadMeals() -> map<int, vector<Meal>>

// 保存餐单数据
bool saveMeals(const map<int, vector<Meal>>&) -> bool
```

## 5. 非功能性需求

### 5.1 性能要求

- 系统响应时间 < 1秒
- 推荐算法执行时间 < 2秒
- 支持至少100个用户数据
- 支持至少1000条餐单记录

### 5.2 可靠性要求

- 数据持久化保证
- 异常处理机制
- 输入验证
- 错误提示

### 5.3 可维护性要求

- 模块化设计
- 清晰的代码注释
- 统一的命名规范
- 详细的文档

### 5.4 可扩展性要求

- 易于添加新食物
- 易于扩展推荐算法
- 支持更多数据源
- 预留GUI接口

## 6. 测试设计

### 6.1 单元测试

- User类方法测试
- Food类方法测试
- Meal类方法测试
- Database类CRUD测试
- RecommendationEngine算法测试

### 6.2 集成测试

- 用户注册登录流程测试
- 推荐功能完整流程测试
- 数据持久化测试
- 多用户场景测试

### 6.3 功能测试

| 测试项 | 测试内容 | 预期结果 |
|--------|----------|----------|
| 用户注册 | 输入完整信息注册 | 成功创建用户 |
| 用户登录 | 正确用户名密码 | 成功登录 |
| 获取推荐 | 点击获取推荐 | 生成三餐推荐 |
| 保存餐单 | 保存推荐餐单 | 写入数据文件 |
| 查看历史 | 查看历史记录 | 正确显示历史 |
| 营养可视化 | 查看营养图表 | 正确显示图表 |

### 6.4 性能测试

- 加载100个用户数据的时间
- 生成推荐的平均时间
- 查询1000条记录的时间
- 内存占用情况

## 7. 部署说明

### 7.1 编译部署

**Windows (VS2022)**:
```bash
mkdir build
cd build
cmake .. -G "Visual Studio 17 2022"
cmake --build . --config Release
```

**Linux (GCC)**:
```bash
mkdir build
cd build
cmake ..
make
```

### 7.2 目录结构

```
MealRecommendationSystem/
├── bin/                    # 可执行文件
├── data/                   # 数据文件
│   ├── users.txt
│   ├── foods.txt
│   └── meals.txt
├── docs/                   # 文档
├── include/                # 头文件
├── src/                    # 源文件
└── README.md
```

### 7.3 运行环境

- 操作系统：Windows 10/11, Linux
- 内存：≥ 512MB
- 硬盘：≥ 50MB
- 终端：支持UTF-8编码

## 8. 安全性设计

### 8.1 数据安全

- 密码明文存储（当前版本）
- 文件访问权限控制
- 数据备份机制

### 8.2 输入验证

- 防止SQL注入（虽然不使用SQL）
- 字符串长度限制
- 数值范围检查
- 特殊字符过滤

## 9. 未来改进

### 9.1 功能改进

1. 密码加密存储
2. 使用SQLite数据库
3. 添加图形用户界面
4. 机器学习推荐算法
5. 社交分享功能
6. 食谱推荐
7. 运动数据集成

### 9.2 技术改进

1. 使用设计模式优化代码
2. 添加单元测试框架
3. 实现配置文件管理
4. 日志系统
5. 多线程支持
6. 网络功能

## 10. 附录

### 10.1 术语表

| 术语 | 说明 |
|------|------|
| BMR | 基础代谢率 |
| TDEE | 总能量消耗 |
| kcal | 千卡（热量单位）|
| 宏量营养素 | 蛋白质、碳水、脂肪 |
| 微量营养素 | 维生素、矿物质 |

### 10.2 参考资料

1. Mifflin-St Jeor公式
2. 中国居民膳食指南
3. USDA营养数据库
4. C++17标准库文档

---

**文档版本**：v1.0  
**编写日期**：2024年  
**维护团队**：开发组
