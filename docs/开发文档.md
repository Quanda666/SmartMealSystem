# 智能配餐推荐系统 - 开发文档

## 1. 开发环境配置

### 1.1 必需工具

- **C++编译器**：
  - Windows: Visual Studio 2022 (MSVC)
  - Linux: GCC 8.0+ 或 Clang 7.0+
  - macOS: Xcode Command Line Tools

- **构建工具**：
  - CMake 3.10或更高版本

- **版本控制**：
  - Git

### 1.2 可选工具

- **代码编辑器**：
  - Visual Studio Code
  - CLion
  - Vim/Neovim

- **调试工具**：
  - GDB (Linux)
  - LLDB (macOS)
  - Visual Studio Debugger (Windows)

## 2. 项目结构详解

```
MealRecommendationSystem/
│
├── include/                    # 头文件目录
│   ├── User.h                 # 用户类声明
│   ├── Food.h                 # 食物类声明
│   ├── Meal.h                 # 餐次类声明
│   ├── Database.h             # 数据库类声明
│   ├── RecommendationEngine.h # 推荐引擎类声明
│   └── Utils.h                # 工具函数声明
│
├── src/                        # 源文件目录
│   ├── main.cpp               # 主程序入口
│   ├── User.cpp               # 用户类实现
│   ├── Food.cpp               # 食物类实现
│   ├── Meal.cpp               # 餐次类实现
│   ├── Database.cpp           # 数据库类实现
│   ├── RecommendationEngine.cpp # 推荐引擎实现
│   └── Utils.cpp              # 工具函数实现
│
├── data/                       # 数据文件目录
│   ├── users.txt              # 用户数据（运行时生成）
│   ├── foods.txt              # 食物数据（运行时生成）
│   ├── meals.txt              # 餐单数据（运行时生成）
│   └── .gitkeep               # Git目录占位符
│
├── docs/                       # 文档目录
│   ├── 用户使用手册.md
│   ├── 系统设计文档.md
│   ├── VS2022编译说明.md
│   └── 开发文档.md
│
├── build/                      # 构建目录（自动生成）
│   ├── bin/                   # 可执行文件输出
│   └── ...                    # CMake生成文件
│
├── CMakeLists.txt             # CMake配置文件
├── README.md                  # 项目说明
├── .gitignore                 # Git忽略配置
├── build.sh                   # Linux编译脚本
├── build.bat                  # Windows编译脚本
└── run.bat                    # Windows运行脚本
```

## 3. 代码规范

### 3.1 命名规范

#### 类名
- 使用帕斯卡命名法（PascalCase）
- 例如：`User`, `Food`, `RecommendationEngine`

#### 变量名
- 使用驼峰命名法（camelCase）
- 例如：`userName`, `dailyCalorieGoal`, `totalProtein`

#### 常量
- 使用全大写加下划线
- 例如：`MAX_FOODS`, `DEFAULT_CALORIES`

#### 函数名
- 使用驼峰命名法
- 动词开头，表明功能
- 例如：`calculateNutritionGoals()`, `addFood()`, `displayInfo()`

#### 私有成员变量
- 不使用特殊前缀（根据团队习惯可选）
- 例如：`id`, `username`, `foods`

### 3.2 代码格式

#### 缩进
- 使用4个空格进行缩进
- 不使用Tab字符

#### 大括号风格
```cpp
// 推荐：K&R风格
void function() {
    if (condition) {
        doSomething();
    } else {
        doOtherThing();
    }
}
```

#### 空格
```cpp
// 运算符两侧加空格
int result = a + b;

// 逗号后加空格
function(arg1, arg2, arg3);

// 关键字后加空格
if (condition) {
    while (loop) {
        for (int i = 0; i < n; ++i) {
        }
    }
}
```

### 3.3 注释规范

#### 文件头注释
```cpp
/**
 * @file User.h
 * @brief 用户类声明
 * @author 开发团队
 * @date 2024
 */
```

#### 类注释
```cpp
/**
 * @class User
 * @brief 用户信息管理类
 * 
 * 管理用户的基本信息、营养目标和口味偏好
 */
class User {
    // ...
};
```

#### 函数注释
```cpp
/**
 * @brief 计算用户的每日营养目标
 * 
 * 使用Mifflin-St Jeor公式计算BMR，
 * 然后根据活动水平计算TDEE，
 * 最后分配宏量营养素目标
 */
void calculateNutritionGoals();
```

#### 行内注释
```cpp
double bmr = 10 * weight + 6.25 * height - 5 * age + 5;  // Mifflin-St Jeor公式
```

### 3.4 头文件保护

```cpp
#ifndef USER_H
#define USER_H

// 声明内容

#endif  // USER_H
```

## 4. 模块开发指南

### 4.1 添加新食物

在`Database::initializeSampleData()`中添加：

```cpp
foods.push_back(Food(
    26,                          // ID（递增）
    "新食物名称",                 // 名称
    100.0,                       // 热量(kcal/100g)
    5.0,                         // 蛋白质(g)
    20.0,                        // 碳水化合物(g)
    2.0,                         // 脂肪(g)
    1.0,                         // 纤维素(g)
    {"清淡", "鲜"},              // 口味标签
    "蔬菜"                       // 类别
));
```

### 4.2 修改推荐算法

在`RecommendationEngine::calculateFoodScore()`中调整评分权重：

```cpp
// 调整营养匹配权重
double calorieDiff = std::abs(food.getCalories() - remainingCalories);
score -= calorieDiff * 0.1;  // 修改此权重

// 调整口味偏好权重
for (const auto& preferredTag : user.getPreferredTags()) {
    if (food.hasTag(preferredTag)) {
        score += 30.0;  // 修改此加分
    }
}
```

### 4.3 添加新功能模块

1. 在`include/`创建头文件
2. 在`src/`创建实现文件
3. 在`CMakeLists.txt`添加源文件
4. 在`main.cpp`中集成功能

示例：添加运动记录功能

```cpp
// include/Exercise.h
#ifndef EXERCISE_H
#define EXERCISE_H

class Exercise {
private:
    int id;
    std::string name;
    double caloriesBurned;
public:
    // 方法声明
};

#endif
```

```cpp
// src/Exercise.cpp
#include "../include/Exercise.h"

// 方法实现
```

```cmake
# CMakeLists.txt
set(SOURCES
    src/main.cpp
    src/User.cpp
    src/Food.cpp
    src/Meal.cpp
    src/Database.cpp
    src/RecommendationEngine.cpp
    src/Utils.cpp
    src/Exercise.cpp  # 添加新文件
)
```

## 5. 数据库开发

### 5.1 文件格式设计

#### 选择分隔符
- 使用`|`作为主分隔符
- 使用`,`作为列表分隔符
- 避免使用用户可能输入的字符

#### 数据验证
```cpp
// 读取时验证
auto parts = split(line, '|');
if (parts.size() < EXPECTED_SIZE) {
    std::cerr << "数据格式错误: " << line << std::endl;
    continue;
}
```

### 5.2 添加新数据表

```cpp
// 1. 定义数据结构
class Recipe {
private:
    int id;
    std::string name;
    std::vector<int> foodIds;
    std::string instructions;
public:
    // ...
};

// 2. 在Database类中添加
class Database {
private:
    std::vector<Recipe> recipes;
    std::string recipesFile;
public:
    bool loadRecipes();
    bool saveRecipes();
    // ...
};

// 3. 实现加载/保存方法
bool Database::loadRecipes() {
    std::ifstream file(recipesFile);
    // 读取逻辑
}
```

### 5.3 数据迁移

如果修改了数据格式，需要提供迁移函数：

```cpp
void Database::migrateData() {
    // 读取旧格式
    // 转换为新格式
    // 保存新格式
}
```

## 6. 算法优化

### 6.1 推荐算法优化

#### 当前问题
- 简单线性评分可能不够精确
- 没有考虑食物多样性
- 没有学习用户偏好

#### 优化方向

**1. 协同过滤**
```cpp
// 基于用户历史记录推荐
double calculateSimilarity(const User& user1, const User& user2) {
    // 计算用户相似度
}

std::vector<Food> getCollaborativeRecommendations(const User& user) {
    // 找到相似用户
    // 推荐他们喜欢的食物
}
```

**2. 多样性保证**
```cpp
std::vector<Food> ensureDiversity(std::vector<Food> foods, int days) {
    // 确保N天内不重复或少重复
    std::map<int, int> recentFoods;
    // 调整评分，降低最近吃过的食物的分数
}
```

**3. 营养平衡优化**
```cpp
// 使用线性规划或遗传算法
// 在满足营养约束的前提下最大化口味匹配
```

### 6.2 性能优化

#### 缓存常用数据
```cpp
class Database {
private:
    std::map<int, Food*> foodCache;  // ID到Food的快速索引
    std::map<std::string, std::vector<Food*>> categoryCache;  // 类别索引
public:
    void buildCaches() {
        for (auto& food : foods) {
            foodCache[food.getId()] = &food;
            categoryCache[food.getCategory()].push_back(&food);
        }
    }
};
```

#### 减少文件I/O
```cpp
// 批量保存而不是每次修改都保存
class Database {
private:
    bool dirty = false;  // 标记数据是否修改
public:
    void markDirty() { dirty = true; }
    ~Database() {
        if (dirty) {
            saveAll();
        }
    }
};
```

## 7. 测试开发

### 7.1 单元测试示例

使用Google Test框架：

```cpp
#include <gtest/gtest.h>
#include "../include/User.h"

TEST(UserTest, CalculateNutritionGoals) {
    User user(1, "test", "pass");
    user.setAge(25);
    user.setWeight(70);
    user.setHeight(175);
    user.setGender("male");
    user.setActivityLevel("moderate");
    
    user.calculateNutritionGoals();
    
    EXPECT_GT(user.getDailyCalorieGoal(), 0);
    EXPECT_GT(user.getDailyProteinGoal(), 0);
}

TEST(UserTest, AddPreferredTag) {
    User user(1, "test", "pass");
    user.addPreferredTag("清淡");
    
    auto tags = user.getPreferredTags();
    EXPECT_EQ(tags.size(), 1);
    EXPECT_NE(tags.find("清淡"), tags.end());
}
```

### 7.2 集成测试

```cpp
TEST(IntegrationTest, CompleteRecommendationFlow) {
    // 1. 创建用户
    User user(1, "test", "pass");
    user.setAge(25);
    user.setWeight(70);
    user.setHeight(175);
    user.setGender("male");
    user.calculateNutritionGoals();
    
    // 2. 加载食物数据库
    Database db;
    db.initializeSampleData();
    
    // 3. 获取推荐
    RecommendationEngine engine;
    engine.setFoodDatabase(db.getAllFoods());
    auto meals = engine.recommendDailyMeals(user, "2024-01-15");
    
    // 4. 验证结果
    EXPECT_EQ(meals.size(), 3);  // 早中晚三餐
    EXPECT_GT(meals[0].getFoods().size(), 0);
}
```

## 8. 调试技巧

### 8.1 日志输出

添加调试日志：

```cpp
#ifdef DEBUG
#define LOG(x) std::cout << "[DEBUG] " << x << std::endl
#else
#define LOG(x)
#endif

// 使用
LOG("计算营养目标: BMR = " << bmr);
```

### 8.2 断言

```cpp
#include <cassert>

void addFood(const Food& food) {
    assert(food.getCalories() >= 0 && "热量不能为负");
    assert(!food.getName().empty() && "食物名称不能为空");
    foods.push_back(food);
}
```

### 8.3 内存检查

使用Valgrind（Linux）：

```bash
valgrind --leak-check=full ./build/bin/MealRecommendationSystem
```

## 9. 版本控制

### 9.1 Git工作流

```bash
# 创建功能分支
git checkout -b feature/add-exercise-tracking

# 开发并提交
git add .
git commit -m "添加运动记录功能"

# 合并到主分支
git checkout main
git merge feature/add-exercise-tracking
```

### 9.2 提交信息规范

```
<type>: <subject>

<body>

<footer>
```

类型(type)：
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

示例：
```
feat: 添加食物搜索功能

- 实现按名称搜索
- 实现按类别筛选
- 添加搜索历史记录

Closes #123
```

## 10. 发布流程

### 10.1 版本号规范

使用语义化版本：`主版本.次版本.修订号`

- 主版本：不兼容的API修改
- 次版本：向下兼容的功能新增
- 修订号：向下兼容的问题修正

### 10.2 发布清单

- [ ] 更新版本号
- [ ] 更新CHANGELOG
- [ ] 运行所有测试
- [ ] 生成Release版本
- [ ] 创建安装包
- [ ] 更新文档
- [ ] 创建Git标签
- [ ] 发布到GitHub Releases

### 10.3 打包脚本

```bash
#!/bin/bash
VERSION="1.0.0"
PACKAGE_NAME="MealRecommendationSystem-v${VERSION}"

# 编译Release版本
cmake --build build --config Release

# 创建发布目录
mkdir -p release/${PACKAGE_NAME}

# 复制文件
cp build/bin/Release/MealRecommendationSystem release/${PACKAGE_NAME}/
cp -r data release/${PACKAGE_NAME}/
cp README.md release/${PACKAGE_NAME}/
cp docs/用户使用手册.md release/${PACKAGE_NAME}/

# 打包
cd release
tar -czf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}/
zip -r ${PACKAGE_NAME}.zip ${PACKAGE_NAME}/
```

## 11. 常见问题

### Q1: 编译错误：找不到头文件

**解决**：检查CMakeLists.txt中的include目录设置

### Q2: 运行时找不到data文件夹

**解决**：确保工作目录正确，或使用绝对路径

### Q3: 中文显示乱码

**解决**：确保源文件使用UTF-8编码，Windows需要设置控制台代码页

### Q4: 内存泄漏

**解决**：使用智能指针，避免裸指针

## 12. 资源链接

- [C++ Reference](https://en.cppreference.com/)
- [CMake Documentation](https://cmake.org/documentation/)
- [Google Test](https://github.com/google/googletest)
- [Visual Studio Documentation](https://docs.microsoft.com/visualstudio/)

---

**文档维护**：开发团队  
**最后更新**：2024年
